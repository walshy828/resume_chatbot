{% extends "admin/admin_base.html" %}

{% block title %}Intelligence & Analytics - {{ config.APP_NAME }}{% endblock %}

{% block admin_title %}Signal Intelligence{% endblock %}

{% block admin_content %}
<div class="px-8 py-8 space-y-8 max-w-[1600px] mx-auto">
    <!-- Header -->
    <div class="flex flex-col md:flex-row md:items-center justify-between gap-6">
        <div>
            <h1 class="text-2xl font-display font-bold text-gray-900 dark:text-white">Conversation Audit</h1>
            <p class="text-sm text-gray-500 mt-1">Review live and historical interactions to refine your AI's knowledge
                base.</p>
        </div>

        <div class="flex items-center gap-3">
            <div class="relative">
                <i data-lucide="search" class="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-gray-400"></i>
                <input type="text" id="search-input" placeholder="Origin or ID..."
                    class="pl-10 pr-4 py-2 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-xl text-xs focus:ring-2 focus:ring-blue-500 outline-none w-64">
            </div>
            <div class="flex items-center gap-2">
                <span class="text-[10px] font-bold text-gray-400 uppercase tracking-widest">Sort By</span>
                <select id="sort-select"
                    class="px-4 py-2 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-xl text-xs focus:ring-2 focus:ring-blue-500 outline-none font-bold">
                    <option value="active">Recently Active</option>
                    <option value="recent">Newly Started</option>
                    <option value="messages">Message Count</option>
                    <option value="oldest">Oldest First</option>
                </select>
            </div>
        </div>
    </div>

    <!-- Signals List -->
    <div class="space-y-4" id="sessions-list">
        {% for session in sessions %}
        <div class="session-item group bg-white dark:bg-gray-800 rounded-2xl border border-gray-100 dark:border-gray-700 shadow-sm hover:shadow-md transition-all overflow-hidden"
            data-session-id="{{ session.id }}" data-started="{{ session.started_at.timestamp() }}"
            data-active="{{ session.last_activity.timestamp() }}" data-messages="{{ session.message_count }}"
            data-search="{{ session.session_id|lower }} {{ session.ip_address|lower }} {{ session.location|lower }} {{ session.title|lower if session.title else '' }}">

            <div class="flex items-center justify-between p-6">
                <div class="flex items-center space-x-6">
                    <div class="relative">
                        <div
                            class="w-12 h-12 rounded-xl bg-gray-50 dark:bg-gray-900 flex items-center justify-center text-gray-400 group-hover:bg-blue-600 group-hover:text-white transition-all shadow-sm">
                            <i data-lucide="messages-square" class="w-6 h-6"></i>
                        </div>
                        {% if (now - session.last_activity).total_seconds() < 300 %} <span
                            class="absolute -top-1 -right-1 flex h-3 w-3">
                            <span
                                class="animate-ping absolute inline-flex h-full w-full rounded-full bg-green-400 opacity-75"></span>
                            <span
                                class="relative inline-flex rounded-full h-3 w-3 bg-green-500 border-2 border-white dark:border-gray-800"></span>
                            </span>
                            {% endif %}
                    </div>

                    <div>
                        <p class="text-[10px] font-bold text-gray-400 uppercase tracking-widest mb-1">Session ID /
                            Context</p>
                        <h3 class="text-sm font-bold text-gray-900 dark:text-white font-mono flex items-center gap-2">
                            {{ session.session_id[:12] }}...
                            {% if session.title %}
                            <span class="text-xs font-sans text-blue-500 opacity-70">"{{ session.title|truncate(30)
                                }}"</span>
                            {% endif %}
                        </h3>
                    </div>

                    <div class="hidden lg:block h-8 w-px bg-gray-100 dark:bg-gray-700"></div>

                    <div class="hidden md:block">
                        <p class="text-[10px] font-bold text-gray-400 uppercase tracking-widest mb-1">Origin & IP</p>
                        <p class="text-xs font-medium text-gray-700 dark:text-gray-300">{{ session.location or 'Global
                            Edge' }}</p>
                        <p class="text-[9px] font-mono text-gray-400 mt-0.5">{{ session.ip_address }}</p>
                    </div>

                    <div class="hidden lg:block h-8 w-px bg-gray-100 dark:bg-gray-700"></div>

                    <div class="hidden md:block">
                        <p class="text-[10px] font-bold text-gray-400 uppercase tracking-widest mb-1">Activity Span</p>
                        <div class="flex items-center gap-3">
                            <div class="flex flex-col">
                                <span class="text-[9px] text-gray-400 uppercase leading-none mb-1">Started</span>
                                <span class="text-xs font-bold text-gray-700 dark:text-gray-300">{{
                                    session.started_at.strftime('%b %d, %H:%M') }}</span>
                            </div>
                            <i data-lucide="arrow-right" class="w-3 h-3 text-gray-300"></i>
                            <div class="flex flex-col">
                                <span class="text-[9px] text-gray-400 uppercase leading-none mb-1">Last Message</span>
                                <span class="text-xs font-bold text-blue-600 dark:text-blue-400">{{
                                    session.last_activity.strftime('%b %d, %H:%M') }}</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="flex items-center space-x-6">
                    <div class="flex flex-col items-end">
                        <p class="text-[10px] font-bold text-gray-400 uppercase tracking-widest mb-1">Volume</p>
                        <span
                            class="inline-flex items-center px-2 py-0.5 rounded-lg text-[10px] font-bold bg-blue-50 text-blue-600 dark:bg-blue-900/40 dark:text-blue-400 border border-blue-100 dark:border-blue-800">
                            {{ session.message_count }} Interactions
                        </span>
                    </div>
                    <button onclick="toggleSession({{ session.id }})"
                        class="w-10 h-10 flex items-center justify-center hover:bg-gray-100 dark:hover:bg-gray-700 rounded-xl transition-colors">
                        <i data-lucide="chevron-down" class="w-5 h-5 text-gray-400 transition-transform"
                            id="chevron-{{ session.id }}"></i>
                    </button>
                </div>
            </div>

            <!-- Detailed Transcript -->
            <div id="conversation-{{ session.id }}"
                class="hidden bg-gray-50/50 dark:bg-gray-900/10 border-t border-gray-100 dark:border-gray-700">
                <div class="p-8 max-w-5xl mx-auto">
                    <div
                        class="flex items-center justify-between mb-8 border-b border-gray-100 dark:border-gray-700/50 pb-4">
                        <div class="flex items-center gap-4">
                            <h4 class="text-[10px] font-bold text-gray-400 uppercase tracking-widest">Signal
                                Intelligence Transcript</h4>
                            <span
                                class="px-2 py-0.5 rounded bg-gray-900 text-[8px] text-white font-bold uppercase tracking-tighter">Encrypted</span>
                        </div>
                        <div class="flex items-center space-x-6 text-[10px] font-bold text-gray-400">
                            <div class="flex flex-col items-end">
                                <span class="uppercase text-[8px] text-gray-500">Duration</span>
                                <span class="text-gray-900 dark:text-gray-100">
                                    {% set duration = (session.last_activity - session.started_at).total_seconds() %}
                                    {% if duration < 60 %} < 1 min {% elif duration < 3600 %} {{ (duration /
                                        60)|round|int }} mins {% else %} {{ (duration / 3600)|round(1) }} hours {% endif
                                        %} </span>
                            </div>
                            <div class="flex flex-col items-end border-l border-gray-200 dark:border-gray-700 pl-6">
                                <span class="uppercase text-[8px] text-gray-500">Client Info</span>
                                <span class="text-gray-900 dark:text-gray-100">{{ session.user_agent|truncate(30) or
                                    'Unknown Client' }}</span>
                            </div>
                        </div>
                    </div>

                    <div class="space-y-6">
                        {% for message in session.messages %}
                        <div
                            class="flex {% if message.role == 'user' %}justify-end{% else %}justify-start{% endif %} group/msg">
                            <div
                                class="flex flex-col {% if message.role == 'user' %}items-end{% else %}items-start{% endif %} max-w-[80%]">
                                <span
                                    class="text-[9px] font-bold text-gray-400 mb-1 px-2 uppercase tracking-tighter opacity-0 group-hover/msg:opacity-100 transition-opacity">
                                    {{ message.role }} â€¢ {{ message.timestamp.strftime('%H:%M:%S') }}
                                </span>
                                <div class="relative px-5 py-3 text-sm leading-relaxed shadow-sm
                                            {% if message.role == 'user' %}
                                            bg-blue-600 text-white rounded-[1.25rem] rounded-tr-none
                                            {% else %}
                                            bg-white dark:bg-gray-800 text-gray-700 dark:text-gray-200 border border-gray-100 dark:border-gray-700 rounded-[1.25rem] rounded-tl-none
                                            {% endif %}">
                                    {{ message.content }}
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
        {% else %}
        <div class="p-20 bg-white dark:bg-gray-800 rounded-3xl border border-gray-100 dark:border-gray-700 text-center">
            <i data-lucide="inbox" class="w-16 h-16 mx-auto mb-4 text-gray-300"></i>
            <h3 class="text-xl font-bold text-gray-900 dark:text-white">Empty Signal Space</h3>
            <p class="text-sm text-gray-500 mt-2">Historical conversations will materialize here as they occur.</p>
        </div>
        {% endfor %}
    </div>
</div>

<script>
    function toggleSession(sessionId) {
        const conversation = document.getElementById(`conversation-${sessionId}`);
        const chevron = document.getElementById(`chevron-${sessionId}`);

        if (conversation.classList.contains('hidden')) {
            conversation.classList.remove('hidden');
            chevron.style.transform = 'rotate(180deg)';
            conversation.classList.add('animate-in', 'fade-in', 'slide-in-from-top-2', 'duration-300');
        } else {
            conversation.classList.add('hidden');
            chevron.style.transform = 'rotate(0deg)';
        }
        lucide.createIcons();
    }

    const searchInput = document.getElementById('search-input');
    const sortSelect = document.getElementById('sort-select');
    const sessionsList = document.getElementById('sessions-list');

    function filterSessions() {
        const query = searchInput.value.toLowerCase();
        document.querySelectorAll('.session-item').forEach(item => {
            const isMatch = item.dataset.search.includes(query);
            item.style.display = isMatch ? 'block' : 'none';

            if (isMatch && query.length > 20 && query === item.dataset.search.split(' ')[0]) {
                toggleSession(item.dataset.sessionId);
                item.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
        });
    }

    function sortSessions() {
        const sortBy = sortSelect.value;
        const sessions = Array.from(document.querySelectorAll('.session-item'));

        sessions.sort((a, b) => {
            if (sortBy === 'active') return b.dataset.active - a.dataset.active;
            if (sortBy === 'recent') return b.dataset.started - a.dataset.started;
            if (sortBy === 'oldest') return a.dataset.started - b.dataset.started;
            if (sortBy === 'messages') return b.dataset.messages - a.dataset.messages;
            return 0;
        });

        sessions.forEach(s => sessionsList.appendChild(s));
    }

    searchInput?.addEventListener('input', filterSessions);
    sortSelect?.addEventListener('change', sortSessions);

    // Initial Sort
    window.addEventListener('DOMContentLoaded', () => {
        sortSessions();

        const urlParams = new URLSearchParams(window.location.search);
        const drillSearch = urlParams.get('search');
        if (drillSearch) {
            searchInput.value = drillSearch;
            filterSessions();
        }
    });
</script>
{% endblock %}