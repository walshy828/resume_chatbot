{% extends "admin/admin_base.html" %}

{% block title %}Intelligence & Analytics - {{ config.APP_NAME }}{% endblock %}

{% block admin_title %}Signal Intelligence{% endblock %}

{% block admin_content %}
<div class="px-8 py-8 space-y-8 max-w-[1600px] mx-auto">
    <!-- Header -->
    <div class="flex flex-col md:flex-row md:items-center justify-between gap-6">
        <div>
            <h1 class="text-2xl font-display font-bold text-gray-900 dark:text-white">Conversation Audit</h1>
            <p class="text-sm text-gray-500 mt-1">Review live and historical interactions to refine your AI's knowledge
                base.</p>
        </div>

        <div class="flex items-center gap-3">
            <div class="relative">
                <i data-lucide="search" class="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-gray-400"></i>
                <input type="text" id="search-input" placeholder="Origin or ID..."
                    class="pl-10 pr-4 py-2 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-xl text-xs focus:ring-2 focus:ring-blue-500 outline-none w-64">
            </div>
            <select id="sort-select"
                class="px-4 py-2 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-xl text-xs focus:ring-2 focus:ring-blue-500 outline-none">
                <option value="recent">Recency</option>
                <option value="messages">Volume</option>
                <option value="oldest">Historical</option>
            </select>
        </div>
    </div>

    <!-- Signals List -->
    <div class="space-y-4" id="sessions-list">
        {% for session in sessions %}
        <div class="session-item group bg-white dark:bg-gray-800 rounded-2xl border border-gray-100 dark:border-gray-700 shadow-sm hover:shadow-md transition-all overflow-hidden"
            data-session-id="{{ session.id }}" data-started="{{ session.started_at.timestamp() }}"
            data-messages="{{ session.message_count }}"
            data-search="{{ session.session_id|lower }} {{ session.ip_address|lower }} {{ session.location|lower }}">

            <div class="flex items-center justify-between p-6">
                <div class="flex items-center space-x-6">
                    <div
                        class="w-12 h-12 rounded-xl bg-gray-50 dark:bg-gray-900 flex items-center justify-center text-gray-400 group-hover:bg-blue-600 group-hover:text-white transition-all shadow-sm">
                        <i data-lucide="messages-square" class="w-6 h-6"></i>
                    </div>
                    <div>
                        <p class="text-[10px] font-bold text-gray-400 uppercase tracking-widest mb-1">Session ID</p>
                        <h3 class="text-sm font-bold text-gray-900 dark:text-white font-mono">{{ session.session_id[:16]
                            }}...</h3>
                    </div>
                    <div class="hidden md:block">
                        <p class="text-[10px] font-bold text-gray-400 uppercase tracking-widest mb-1">Origin Point</p>
                        <p class="text-xs font-medium text-gray-700 dark:text-gray-300">{{ session.location or 'Global
                            Edge' }}</p>
                    </div>
                    <div class="hidden md:block">
                        <p class="text-[10px] font-bold text-gray-400 uppercase tracking-widest mb-1">Payload Volume</p>
                        <span
                            class="inline-flex items-center px-2 py-0.5 rounded-full text-[10px] font-bold bg-blue-50 text-blue-600 dark:bg-blue-900/40 dark:text-blue-400 border border-blue-100 dark:border-blue-800">
                            {{ session.message_count }} Interactions
                        </span>
                    </div>
                </div>

                <div class="flex items-center space-x-4">
                    <div class="text-right">
                        <p class="text-[10px] font-bold text-gray-400 uppercase tracking-widest">{{
                            session.last_activity.strftime('%H:%M') }}</p>
                        <p class="text-[10px] text-gray-500">{{ session.started_at.strftime('%b %d') }}</p>
                    </div>
                    <button onclick="toggleSession({{ session.id }})"
                        class="p-2 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-xl transition-colors">
                        <i data-lucide="chevron-down" class="w-5 h-5 text-gray-400 transition-transform"
                            id="chevron-{{ session.id }}"></i>
                    </button>
                </div>
            </div>

            <!-- Detailed Transcript -->
            <div id="conversation-{{ session.id }}"
                class="hidden bg-gray-50/50 dark:bg-gray-900/30 border-t border-gray-100 dark:border-gray-700">
                <div class="p-8 max-w-4xl mx-auto space-y-6">
                    <div class="flex items-center justify-between mb-2">
                        <h4 class="text-[10px] font-bold text-gray-400 uppercase tracking-widest">Signal Transcript</h4>
                        <div class="flex items-center space-x-3 text-[10px] font-bold text-gray-500">
                            <span><i data-lucide="map-pin" class="w-3 h-3 inline mr-1"></i> {{ session.ip_address
                                }}</span>
                            <span><i data-lucide="monitor" class="w-3 h-3 inline mr-1"></i> WebKit/AI-Assist</span>
                        </div>
                    </div>

                    <div class="space-y-4">
                        {% for message in session.messages %}
                        <div
                            class="flex flex-col {% if message.role == 'user' %}items-end{% else %}items-start{% endif %}">
                            <div class="max-w-[85%] rounded-2xl px-5 py-3 text-sm leading-relaxed shadow-sm
                                        {% if message.role == 'user' %}
                                        bg-blue-600 text-white rounded-tr-none
                                        {% else %}
                                        bg-white dark:bg-gray-800 text-gray-700 dark:text-gray-300 border border-gray-100 dark:border-gray-700 rounded-tl-none
                                        {% endif %}">
                                {{ message.content }}
                            </div>
                            <span class="text-[9px] font-bold text-gray-400 mt-1 uppercase tracking-tighter">
                                {{ message.timestamp.strftime('%H:%M:%S') }}
                            </span>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
        {% else %}
        <div class="p-20 bg-white dark:bg-gray-800 rounded-3xl border border-gray-100 dark:border-gray-700 text-center">
            <i data-lucide="inbox" class="w-16 h-16 mx-auto mb-4 text-gray-300"></i>
            <h3 class="text-xl font-bold text-gray-900 dark:text-white">Empty Signal Space</h3>
            <p class="text-sm text-gray-500 mt-2">Historical conversations will materialize here as they occur.</p>
        </div>
        {% endfor %}
    </div>
</div>

<script>
    function toggleSession(sessionId) {
        const conversation = document.getElementById(`conversation-${sessionId}`);
        const chevron = document.getElementById(`chevron-${sessionId}`);

        if (conversation.classList.contains('hidden')) {
            conversation.classList.remove('hidden');
            chevron.style.transform = 'rotate(180deg)';
            conversation.classList.add('animate-in', 'fade-in', 'slide-in-from-top-2', 'duration-300');
        } else {
            conversation.classList.add('hidden');
            chevron.style.transform = 'rotate(0deg)';
        }
        lucide.createIcons();
    }

    const searchInput = document.getElementById('search-input');
    const sortSelect = document.getElementById('sort-select');
    const sessionsList = document.getElementById('sessions-list');

    function filterSessions() {
        const query = searchInput.value.toLowerCase();
        document.querySelectorAll('.session-item').forEach(item => {
            const isMatch = item.dataset.search.includes(query);
            item.style.display = isMatch ? 'block' : 'none';

            // Auto-expand if exact match from drill-down
            if (isMatch && query.length > 20 && query === item.dataset.search.split(' ')[0]) {
                toggleSession(item.dataset.sessionId);
                item.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
        });
    }

    searchInput?.addEventListener('input', filterSessions);

    sortSelect?.addEventListener('change', () => {
        const sortBy = sortSelect.value;
        const sessions = Array.from(document.querySelectorAll('.session-item'));

        sessions.sort((a, b) => {
            if (sortBy === 'recent') return b.dataset.started - a.dataset.started;
            if (sortBy === 'oldest') return a.dataset.started - b.dataset.started;
            if (sortBy === 'messages') return b.dataset.messages - a.dataset.messages;
        });

        sessions.forEach(s => sessionsList.appendChild(s));
    });

    // Handle incoming search query from drill-down
    window.addEventListener('DOMContentLoaded', () => {
        const urlParams = new URLSearchParams(window.location.search);
        const drillSearch = urlParams.get('search');
        if (drillSearch) {
            searchInput.value = drillSearch;
            filterSessions();
        }
    });
</script>
{% endblock %}