{% extends "base.html" %}

{% block title %}Settings - Admin{% endblock %}

{% block content %}
<div class="min-h-screen bg-gray-50 dark:bg-gray-900">
    <!-- Navigation -->
    <nav class="bg-white dark:bg-gray-800 border-b border-gray-200 dark:border-gray-700">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <div class="flex items-center space-x-4">
                    <a href="{{ url_for('admin_dashboard') }}"
                        class="text-gray-600 dark:text-gray-300 hover:text-gray-900 dark:hover:text-white">
                        <i data-lucide="arrow-left" class="w-5 h-5"></i>
                    </a>
                    <h1 class="text-xl font-display font-bold text-gray-900 dark:text-white">Settings</h1>
                </div>

                <div class="flex items-center space-x-4">
                    <a href="{{ url_for('admin_logout') }}"
                        class="text-gray-600 dark:text-gray-300 hover:text-gray-900 dark:hover:text-white inline-flex items-center space-x-2">
                        <i data-lucide="log-out" class="w-5 h-5"></i>
                        <span class="hidden sm:inline">Logout</span>
                    </a>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Chatbot Configuration -->
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 mb-6">
            <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700">
                <h2 class="text-lg font-semibold text-gray-900 dark:text-white">Chatbot Configuration</h2>
            </div>

            <form method="POST" enctype="multipart/form-data" class="p-6 space-y-6">
                <!-- Chatbot Name -->
                <div>
                    <label for="chatbot_name" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                        Chatbot Name
                    </label>
                    <input type="text" id="chatbot_name" name="chatbot_name" value="{{ settings.chatbot_name }}"
                        required
                        class="block w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-gray-50 dark:bg-gray-700 text-gray-900 dark:text-white placeholder-gray-500 dark:placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        placeholder="e.g., Dan's AI Assistant">
                    <p class="mt-1 text-sm text-gray-500 dark:text-gray-400">This name will appear in the chat interface
                    </p>
                </div>

                <!-- Chatbot Icon -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                        Chatbot Icon
                    </label>
                    <div class="flex items-center space-x-4">
                        <div
                            class="w-16 h-16 rounded-full bg-gradient-to-br from-blue-500 to-purple-600 flex items-center justify-center">
                            <i data-lucide="bot" class="w-8 h-8 text-white"></i>
                        </div>
                        <div class="flex-1">
                            <input type="file" id="chatbot_icon" name="chatbot_icon" accept="image/*"
                                class="block w-full text-sm text-gray-900 dark:text-white file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-medium file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100 dark:file:bg-blue-900/30 dark:file:text-blue-400 dark:hover:file:bg-blue-900/50">
                            <p class="mt-1 text-sm text-gray-500 dark:text-gray-400">Upload PNG, JPG, or SVG (max 2MB)
                            </p>
                        </div>
                    </div>
                </div>

                <!-- Personality Prompt -->
                <div>
                    <label for="personality_prompt"
                        class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                        Personality Prompt
                    </label>
                    <textarea id="personality_prompt" name="personality_prompt" rows="12"
                        class="block w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-gray-50 dark:bg-gray-700 text-gray-900 dark:text-white placeholder-gray-500 dark:placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent font-mono text-sm"
                        placeholder="Define how the chatbot should behave and respond...">{{ settings.personality_prompt }}</textarea>
                    <p class="mt-1 text-sm text-gray-500 dark:text-gray-400">This prompt defines the chatbot's
                        personality and behavior</p>
                </div>

                <!-- Submit Button -->
                <div class="flex justify-end">
                    <button type="submit"
                        class="bg-gradient-to-r from-blue-500 to-purple-600 hover:from-blue-600 hover:to-purple-700 text-white font-medium py-3 px-6 rounded-lg transition-all duration-200 transform hover:scale-[1.02] focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 dark:focus:ring-offset-gray-800 inline-flex items-center space-x-2">
                        <i data-lucide="save" class="w-5 h-5"></i>
                        <span>Save Settings</span>
                    </button>
                </div>
            </form>
        </div>

        <!-- Resume Management -->
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700"
            id="resumes">
            <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700">
                <h2 class="text-lg font-semibold text-gray-900 dark:text-white">Resume Artifacts</h2>
                <p class="text-sm text-gray-600 dark:text-gray-400 mt-1">Upload resume files to provide context for the
                    chatbot</p>
            </div>

            <div class="p-6">
                <!-- Upload Form -->
                <form id="resume-upload-form" class="mb-6">
                    <div
                        class="border-2 border-dashed border-gray-300 dark:border-gray-600 rounded-lg p-8 text-center hover:border-blue-500 dark:hover:border-blue-400 transition-colors">
                        <i data-lucide="upload-cloud"
                            class="w-12 h-12 mx-auto mb-4 text-gray-400 dark:text-gray-600"></i>
                        <label for="resume-file" class="cursor-pointer">
                            <span
                                class="text-blue-600 dark:text-blue-400 font-medium hover:text-blue-700 dark:hover:text-blue-300">Click
                                to upload</span>
                            <span class="text-gray-600 dark:text-gray-400"> or drag and drop</span>
                        </label>
                        <input type="file" id="resume-file" name="resume" accept=".pdf,.doc,.docx,.txt" class="hidden">
                        <p class="text-sm text-gray-500 dark:text-gray-400 mt-2">PDF, DOC, DOCX, or TXT (max 16MB)</p>
                    </div>

                    <!-- Upload Progress -->
                    <div id="upload-progress" class="hidden mt-4">
                        <div class="bg-gray-200 dark:bg-gray-700 rounded-full h-2 overflow-hidden">
                            <div id="progress-bar"
                                class="bg-gradient-to-r from-blue-500 to-purple-600 h-full transition-all duration-300"
                                style="width: 0%"></div>
                        </div>
                        <p id="upload-status" class="text-sm text-gray-600 dark:text-gray-400 mt-2 text-center"></p>
                    </div>
                </form>

                <!-- Text Artifact Upload -->
                <div class="mb-8">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-sm font-medium text-gray-700 dark:text-gray-300">Or Paste Resume Text</h3>
                        <button type="button" id="toggle-text-upload"
                            class="text-sm text-blue-600 dark:text-blue-400 hover:text-blue-700 dark:hover:text-blue-300">
                            Show/Hide Text Input
                        </button>
                    </div>

                    <form id="text-upload-form" class="hidden space-y-4">
                        <div>
                            <label for="resume-text" class="sr-only">Resume Text</label>
                            <textarea id="resume-text" name="resume_text" rows="10"
                                class="block w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-gray-50 dark:bg-gray-700 text-gray-900 dark:text-white placeholder-gray-500 dark:placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent font-mono text-sm"
                                placeholder="Paste resume text content here..."></textarea>
                        </div>
                        <div class="flex justify-end">
                            <button type="submit"
                                class="bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-200 hover:bg-gray-50 dark:hover:bg-gray-600 font-medium py-2 px-4 rounded-lg transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 dark:focus:ring-offset-gray-800">
                                Save as Artifact
                            </button>
                        </div>
                    </form>
                </div>

                <!-- Uploaded Resumes List -->
                <div class="space-y-3">
                    <h3 class="text-sm font-medium text-gray-700 dark:text-gray-300">Uploaded Files</h3>
                    {% if resumes %}
                    {% for resume in resumes %}
                    <div
                        class="flex items-center justify-between p-4 bg-gray-50 dark:bg-gray-700/50 rounded-lg border border-gray-200 dark:border-gray-700">
                        <div class="flex items-center space-x-3">
                            <div
                                class="w-10 h-10 rounded-lg bg-blue-100 dark:bg-blue-900/30 flex items-center justify-center">
                                <i data-lucide="file-text" class="w-5 h-5 text-blue-600 dark:text-blue-400"></i>
                            </div>
                            <div>
                                <p class="text-sm font-medium text-gray-900 dark:text-white">{{ resume.original_filename
                                    }}</p>
                                <p class="text-xs text-gray-500 dark:text-gray-400">Uploaded {{
                                    resume.uploaded_at.strftime('%Y-%m-%d %H:%M') }}</p>
                            </div>
                        </div>
                        <div class="flex items-center space-x-2">
                            <!-- Download/View Button -->
                            <a href="{{ url_for('uploaded_file', filename='resumes/' + resume.filename) }}"
                                target="_blank"
                                class="text-gray-600 dark:text-gray-400 hover:text-blue-600 dark:hover:text-blue-400 p-2"
                                title="Download/View">
                                <i data-lucide="download" class="w-5 h-5"></i>
                            </a>

                            <!-- Edit Button (Text only) -->
                            {% if resume.original_filename.endswith('.txt') %}
                            <button type="button" onclick="editResume({{ resume.id }})"
                                class="text-gray-600 dark:text-gray-400 hover:text-blue-600 dark:hover:text-blue-400 p-2"
                                title="Edit Content">
                                <i data-lucide="edit-2" class="w-5 h-5"></i>
                            </button>
                            {% endif %}

                            <!-- Delete Button -->
                            <form method="POST" action="{{ url_for('delete_resume', resume_id=resume.id) }}"
                                onsubmit="return confirm('Are you sure you want to delete this resume?');"
                                class="inline">
                                <button type="submit"
                                    class="text-red-600 dark:text-red-400 hover:text-red-700 dark:hover:text-red-300 p-2"
                                    title="Delete">
                                    <i data-lucide="trash-2" class="w-5 h-5"></i>
                                </button>
                            </form>
                        </div>
                    </div>
                    {% endfor %}
                    {% else %}
                    <div class="text-center py-8 text-gray-500 dark:text-gray-400">
                        <i data-lucide="inbox" class="w-12 h-12 mx-auto mb-2 opacity-50"></i>
                        <p class="text-sm">No resumes uploaded yet</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Edit Resume Modal -->
<div id="edit-resume-modal" class="fixed inset-0 z-[100] hidden" aria-labelledby="modal-title" role="dialog"
    aria-modal="true">
    <!-- Background overlay -->
    <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity backdrop-blur-sm" aria-hidden="true"
        onclick="closeEditModal()"></div>

    <!-- Modal panel layout -->
    <div class="fixed inset-0 z-10 overflow-y-auto">
        <div class="flex min-h-full items-end justify-center p-4 text-center sm:items-center sm:p-0">
            <div
                class="relative transform overflow-hidden rounded-lg bg-white dark:bg-gray-800 text-left shadow-xl transition-all sm:my-8 sm:w-full sm:max-w-4xl border border-gray-200 dark:border-gray-700">
                <div class="bg-white dark:bg-gray-800 px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                    <div class="sm:flex sm:items-start">
                        <div class="mt-3 text-center sm:mt-0 sm:ml-4 sm:text-left w-full">
                            <h3 class="text-lg leading-6 font-medium text-gray-900 dark:text-white" id="modal-title">
                                Edit Resume Content
                            </h3>
                            <div class="mt-4">
                                <form id="edit-resume-form" class="space-y-4">
                                    <input type="hidden" id="edit-resume-id">

                                    <!-- Filename Input -->
                                    <div>
                                        <label for="edit-resume-filename"
                                            class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
                                            Artifact Name
                                        </label>
                                        <input type="text" id="edit-resume-filename"
                                            class="block w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-gray-50 dark:bg-gray-700 text-gray-900 dark:text-white placeholder-gray-500 dark:placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm">
                                    </div>

                                    <!-- Content Textarea -->
                                    <div>
                                        <label for="edit-resume-content"
                                            class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
                                            Content
                                        </label>
                                        <textarea id="edit-resume-content" rows="15"
                                            class="block w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-gray-50 dark:bg-gray-700 text-gray-900 dark:text-white placeholder-gray-500 dark:placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent font-mono text-sm"></textarea>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
                <div
                    class="bg-gray-50 dark:bg-gray-700 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse border-t border-gray-200 dark:border-gray-600">
                    <button type="button" onclick="saveResumeContent()"
                        class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-blue-600 text-base font-medium text-white hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 sm:ml-3 sm:w-auto sm:text-sm">
                        Save Changes
                    </button>
                    <button type="button" onclick="closeEditModal()"
                        class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 dark:border-gray-600 shadow-sm px-4 py-2 bg-white dark:bg-gray-800 text-base font-medium text-gray-700 dark:text-gray-200 hover:bg-gray-50 dark:hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // Resume upload handling
    const resumeFileInput = document.getElementById('resume-file');
    const uploadProgress = document.getElementById('upload-progress');
    const progressBar = document.getElementById('progress-bar');
    const uploadStatus = document.getElementById('upload-status');

    resumeFileInput?.addEventListener('change', async (e) => {
        const file = e.target.files[0];
        if (!file) return;

        const formData = new FormData();
        formData.append('resume', file);

        // Show progress
        uploadProgress.classList.remove('hidden');
        uploadStatus.textContent = 'Uploading...';
        progressBar.style.width = '50%';

        try {
            const response = await fetch('{{ url_for("upload_resume") }}', {
                method: 'POST',
                body: formData
            });

            const result = await response.json();

            if (response.ok) {
                progressBar.style.width = '100%';
                uploadStatus.textContent = 'Upload successful!';
                setTimeout(() => {
                    window.location.reload();
                }, 1000);
            } else {
                uploadStatus.textContent = 'Error: ' + (result.error || 'Upload failed');
                progressBar.classList.add('bg-red-500');
            }
        } catch (error) {
            uploadStatus.textContent = 'Error: ' + error.message;
            progressBar.classList.add('bg-red-500');
        }
    });

    // Drag and drop
    const dropZone = document.querySelector('[for="resume-file"]').parentElement;

    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
        dropZone?.addEventListener(eventName, preventDefaults, false);
    });

    function preventDefaults(e) {
        e.preventDefault();
        e.stopPropagation();
    }

    ['dragenter', 'dragover'].forEach(eventName => {
        dropZone?.addEventListener(eventName, () => {
            dropZone.classList.add('border-blue-500', 'dark:border-blue-400');
        });
    });

    ['dragleave', 'drop'].forEach(eventName => {
        dropZone?.addEventListener(eventName, () => {
            dropZone.classList.remove('border-blue-500', 'dark:border-blue-400');
        });
    });

    dropZone?.addEventListener('drop', (e) => {
        const files = e.dataTransfer.files;
        if (files.length > 0) {
            resumeFileInput.files = files;
            resumeFileInput.dispatchEvent(new Event('change'));
        }
    });

    // Text Artifact Upload Handling
    const toggleTextUpload = document.getElementById('toggle-text-upload');
    const textUploadForm = document.getElementById('text-upload-form');

    toggleTextUpload?.addEventListener('click', () => {
        textUploadForm.classList.toggle('hidden');
    });

    textUploadForm?.addEventListener('submit', async (e) => {
        e.preventDefault();

        const text = document.getElementById('resume-text').value.trim();
        if (!text) return;

        const submitBtn = textUploadForm.querySelector('button[type="submit"]');
        const originalText = submitBtn.textContent;
        submitBtn.disabled = true;
        submitBtn.textContent = 'Saving...';

        try {
            const formData = new FormData();
            formData.append('resume_text', text);

            const response = await fetch('{{ url_for("upload_resume_text") }}', {
                method: 'POST',
                body: formData
            });

            const result = await response.json();

            if (response.ok) {
                submitBtn.textContent = 'Saved!';
                setTimeout(() => {
                    window.location.reload();
                }, 1000);
            } else {
                showToast('Error: ' + (result.error || 'Failed to save text artifact'), 'error');
                submitBtn.disabled = false;
                submitBtn.textContent = originalText;
            }
        } catch (error) {
            showToast('Error: ' + error.message, 'error');
            submitBtn.disabled = false;
            submitBtn.textContent = originalText;
        }
    });

    // Edit Resume Handling
    const editModal = document.getElementById('edit-resume-modal');
    const editForm = document.getElementById('edit-resume-form');
    const editIdInput = document.getElementById('edit-resume-id');
    const editFilenameInput = document.getElementById('edit-resume-filename');
    const editContentInput = document.getElementById('edit-resume-content');

    async function editResume(id) {
        try {
            const response = await fetch(`/admin/resume/${id}`);
            const data = await response.json();

            if (response.ok) {
                editIdInput.value = data.id;
                editFilenameInput.value = data.filename;
                editContentInput.value = data.content;
                editModal.classList.remove('hidden');
            } else {
                showToast('Error fetching resume content', 'error');
            }
        } catch (error) {
            showToast('Error: ' + error.message, 'error');
        }
    }

    async function saveResumeContent() {
        const id = editIdInput.value;
        const filename = editFilenameInput.value;
        const content = editContentInput.value;
        const saveBtn = document.querySelector('#edit-resume-modal button.bg-blue-600');
        const originalText = saveBtn.textContent;

        saveBtn.disabled = true;
        saveBtn.textContent = 'Saving...';

        try {
            const formData = new FormData();
            formData.append('filename', filename);
            formData.append('content', content);

            const response = await fetch(`/admin/resume/${id}/update`, {
                method: 'POST',
                body: formData
            });

            const result = await response.json();

            if (response.ok) {
                closeEditModal();
                window.location.reload();
            } else {
                showToast('Error: ' + (result.error || 'Failed to update resume'), 'error');
                saveBtn.disabled = false;
                saveBtn.textContent = originalText;
            }
        } catch (error) {
            showToast('Error: ' + error.message, 'error');
            saveBtn.disabled = false;
            saveBtn.textContent = originalText;
        }
    }

    function closeEditModal() {
        editModal.classList.add('hidden');
        editIdInput.value = '';
        editFilenameInput.value = '';
        editContentInput.value = '';
    }
</script>
{% endblock %}