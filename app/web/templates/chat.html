{% extends "base.html" %}

{% block title %}Chat - {{ settings.chatbot_name }}{% endblock %}

{% block extra_head %}
<!-- Socket.IO -->
<script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
<!-- Marked.js for Markdown parsing -->
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<!-- DOMPurify for sanitization -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.0.6/purify.min.js"></script>
<style>
    /* Modern Scrollbar */
    .no-scrollbar::-webkit-scrollbar {
        display: none;
    }

    .no-scrollbar {
        -ms-overflow-style: none;
        scrollbar-width: none;
    }

    /* Glass Effects */
    .glass {
        background: rgba(255, 255, 255, 0.7);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
    }

    .dark .glass {
        background: rgba(17, 24, 39, 0.7);
    }

    .glass-sidebar {
        background: rgba(249, 250, 251, 0.8);
        backdrop-filter: blur(12px);
        -webkit-backdrop-filter: blur(12px);
        border-right: 1px solid rgba(229, 231, 235, 0.5);
    }

    .dark .glass-sidebar {
        background: rgba(31, 41, 55, 0.8);
        border-right: 1px solid rgba(55, 65, 81, 0.5);
    }

    /* Animations */
    @keyframes fade-in-up {
        from {
            opacity: 0;
            transform: translateY(10px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .animate-fade-in-up {
        animation: fade-in-up 0.3s ease-out forwards;
    }

    /* Code block styling */
    pre {
        position: relative;
    }

    .copy-btn {
        position: absolute;
        top: 0.5rem;
        right: 0.5rem;
        opacity: 0;
        transition: opacity 0.2s;
    }

    pre:hover .copy-btn {
        opacity: 1;
    }
</style>
{% endblock %}

{% block content %}
<div class="flex h-screen overflow-hidden bg-gray-50 dark:bg-gray-900 selection:bg-blue-500 selection:text-white">

    <!-- Sidebar -->
    <aside id="sidebar"
        class="glass-sidebar w-72 flex-shrink-0 flex flex-col fixed inset-y-0 left-0 z-30 transform -translate-x-full md:relative md:translate-x-0 transition-transform duration-300 ease-[cubic-bezier(0.23,1,0.32,1)]">
        <!-- Sidebar Header -->
        <div class="p-6 flex items-center justify-between">
            <h2
                class="text-xl font-display font-bold text-gray-800 dark:text-gray-100 flex items-center tracking-tight">
                <div
                    class="w-8 h-8 rounded-lg bg-gradient-to-tr from-blue-600 to-indigo-600 flex items-center justify-center mr-3 shadow-lg shadow-blue-500/20">
                    <i data-lucide="message-square" class="w-4 h-4 text-white"></i>
                </div>
                Chats
            </h2>
            <button id="close-sidebar" onclick="toggleSidebar()"
                class="md:hidden p-2 rounded-lg bg-gray-100 dark:bg-gray-800 text-gray-500 hover:text-gray-900 dark:text-gray-400 dark:hover:text-gray-100 transition-colors">
                <i data-lucide="x" class="w-5 h-5"></i>
            </button>
        </div>

        <!-- New Chat Button -->
        <div class="px-6 pb-4">
            <button onclick="startNewChat()"
                class="group w-full flex items-center justify-center space-x-2 bg-gray-900 dark:bg-white hover:bg-gray-800 dark:hover:bg-gray-100 text-white dark:text-gray-900 rounded-xl px-4 py-3.5 transition-all shadow-md hover:shadow-lg active:scale-95">
                <i data-lucide="plus" class="w-4 h-4 transition-transform group-hover:rotate-90"></i>
                <span class="font-medium text-sm">New Chat</span>
            </button>
        </div>

        <!-- History List -->
        <div class="flex-1 overflow-y-auto no-scrollbar px-4 py-2 space-y-1" id="history-list">
            <!-- Items injected by JS -->
            <div class="flex flex-col items-center justify-center h-32 space-y-3">
                <div class="w-6 h-6 border-2 border-blue-500 border-t-transparent rounded-full animate-spin"></div>
                <span class="text-xs text-gray-400">Loading history...</span>
            </div>
        </div>

        <!-- Sidebar Footer -->
        <div
            class="p-4 border-t border-gray-200/50 dark:border-gray-700/50 space-y-4 bg-gray-50/50 dark:bg-gray-800/50 backdrop-blur-sm">
            <!-- Profile Selector -->
            <div class="relative group">
                <label
                    class="block text-[10px] uppercase font-bold text-gray-400 dark:text-gray-500 mb-1.5 tracking-wider">Profile</label>
                <div class="relative">
                    <select id="profile-selector"
                        class="block w-full appearance-none bg-white dark:bg-gray-900 border border-gray-200 dark:border-gray-700 text-gray-900 dark:text-gray-100 text-sm rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent block p-3 pr-10 transition-shadow hover:shadow-sm cursor-pointer">
                        <option value="">Loading...</option>
                    </select>
                    <div
                        class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-3 text-gray-500 dark:text-gray-400">
                        <i data-lucide="chevron-down" class="w-4 h-4"></i>
                    </div>
                </div>
            </div>

            <!-- Mode Toggle -->
            <div>
                <label
                    class="block text-[10px] uppercase font-bold text-gray-400 dark:text-gray-500 mb-1.5 tracking-wider">Mode</label>
                <div class="flex bg-gray-200/50 dark:bg-gray-700/50 rounded-xl p-1">
                    <button id="mode-conversational"
                        class="flex-1 py-2 rounded-lg text-xs font-semibold transition-all duration-200 bg-white dark:bg-gray-800 text-gray-900 dark:text-white shadow-sm ring-1 ring-black/5 dark:ring-white/10"
                        onclick="setMode('conversational')">
                        Chat
                    </button>
                    <button id="mode-simple"
                        class="flex-1 py-2 rounded-lg text-xs font-medium transition-all duration-200 text-gray-500 dark:text-gray-400 hover:text-gray-900 dark:hover:text-white"
                        onclick="setMode('simple')">
                        Concise
                    </button>
                </div>
            </div>

            <div class="pt-1 flex justify-center">
                <a href="/admin/login"
                    class="group flex items-center text-xs text-gray-400 hover:text-blue-600 dark:hover:text-blue-400 transition-colors">
                    <i data-lucide="shield" class="w-3 h-3 mr-1.5 group-hover:scale-110 transition-transform"></i>
                    Admin Access
                </a>
            </div>
        </div>
    </aside>

    <!-- Overlay for mobile sidebar -->
    <div id="sidebar-overlay"
        class="fixed inset-0 bg-gray-900/50 backdrop-blur-sm z-20 hidden md:hidden transition-opacity duration-300"
        onclick="toggleSidebar()"></div>

    <!-- Main Chat Area -->
    <div class="flex-1 flex flex-col h-full overflow-hidden w-full relative">
        <!-- Header -->
        <header
            class="bg-white/80 dark:bg-gray-800/80 backdrop-blur-md border-b border-gray-200/50 dark:border-gray-700/50 flex-none z-10 sticky top-0">
            <div class="px-6 py-4 flex items-center justify-between">
                <div class="flex items-center space-x-4">
                    <button onclick="toggleSidebar()"
                        class="md:hidden p-2 -ml-2 rounded-lg text-gray-500 hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors">
                        <i data-lucide="menu" class="w-6 h-6"></i>
                    </button>

                    <div class="relative group">
                        <div
                            class="w-10 h-10 rounded-xl bg-gradient-to-br from-blue-500 to-indigo-600 flex items-center justify-center shadow-lg shadow-blue-500/20 group-hover:scale-105 transition-transform duration-200">
                            <i data-lucide="bot" class="w-6 h-6 text-white"></i>
                        </div>
                        <div id="status-indicator"
                            class="absolute -bottom-1 -right-1 w-3.5 h-3.5 bg-gray-400 border-2 border-white dark:border-gray-800 rounded-full transition-colors duration-300">
                        </div>
                    </div>

                    <div>
                        <h1
                            class="text-lg font-display font-bold text-gray-900 dark:text-white leading-tight tracking-tight">
                            {{ settings.chatbot_name }}
                        </h1>
                        <div class="flex items-center space-x-2 mt-0.5">
                            <div class="flex items-center" id="connection-status">
                                <span id="status-text"
                                    class="text-xs text-gray-500 dark:text-gray-400">Connecting...</span>
                            </div>
                            <span class="text-gray-300 dark:text-gray-600">|</span>
                            <p class="text-xs font-medium text-gray-500 dark:text-gray-400" id="current-profile-name">
                                Default Profile
                            </p>
                        </div>
                    </div>
                </div>

                <!-- Actions -->
                <div class="flex items-center space-x-2">
                    <button onclick="showChatbotInfo()"
                        class="p-2 text-gray-400 hover:text-blue-500 dark:hover:text-blue-400 transition-colors"
                        title="About">
                        <i data-lucide="info" class="w-5 h-5"></i>
                    </button>
                    <!-- Add more header actions here -->
                </div>
            </div>
        </header>

        <!-- Chat Messages Container -->
        <main class="flex-1 overflow-y-auto scroll-smooth p-4 md:p-6" id="chat-container">
            <div class="max-w-4xl mx-auto w-full pb-4">
                <!-- Welcome Message -->
                <div class="flex flex-col items-center justify-center min-h-[60vh] transition-all duration-500 ease-out"
                    id="welcome-screen">
                    <div
                        class="glass rounded-3xl shadow-xl shadow-gray-200/50 dark:shadow-black/20 border border-white/50 dark:border-gray-700/30 p-8 md:p-12 max-w-lg w-full text-center hover:scale-[1.01] transition-transform duration-300">
                        <div
                            class="w-20 h-20 rounded-2xl bg-gradient-to-tr from-blue-500 to-purple-600 flex items-center justify-center mx-auto mb-6 shadow-xl shadow-blue-500/30">
                            <i data-lucide="sparkles" class="w-10 h-10 text-white"></i>
                        </div>
                        <h2 id="greeting-name"
                            class="text-3xl font-display font-bold text-gray-900 dark:text-white mb-3 tracking-tight">
                            Hi! I'm AI Assistant
                        </h2>
                        <p id="greeting-intro"
                            class="text-base text-gray-600 dark:text-gray-300 leading-relaxed max-w-sm mx-auto">
                            I'm here to share details about my professional background. What would you like to know?
                        </p>

                        <div class="mt-8 grid grid-cols-1 gap-3">
                            <button onclick="sendQuickMessage('Tell me about your experience')"
                                class="group relative overflow-hidden bg-white dark:bg-gray-800 hover:bg-gray-50 dark:hover:bg-gray-700 border border-gray-200 dark:border-gray-700 p-4 rounded-xl transition-all duration-200 text-left hover:shadow-md hover:border-blue-300 dark:hover:border-blue-700">
                                <div class="flex items-center">
                                    <div
                                        class="p-2 rounded-lg bg-blue-50 dark:bg-blue-900/30 text-blue-600 dark:text-blue-400 mr-3 group-hover:scale-110 transition-transform">
                                        <i data-lucide="briefcase" class="w-5 h-5"></i>
                                    </div>
                                    <span class="font-medium text-gray-700 dark:text-gray-200">Tell me about your
                                        experience</span>
                                </div>
                            </button>
                            <button onclick="sendQuickMessage('What technical skills do you have?')"
                                class="group relative overflow-hidden bg-white dark:bg-gray-800 hover:bg-gray-50 dark:hover:bg-gray-700 border border-gray-200 dark:border-gray-700 p-4 rounded-xl transition-all duration-200 text-left hover:shadow-md hover:border-purple-300 dark:hover:border-purple-700">
                                <div class="flex items-center">
                                    <div
                                        class="p-2 rounded-lg bg-purple-50 dark:bg-purple-900/30 text-purple-600 dark:text-purple-400 mr-3 group-hover:scale-110 transition-transform">
                                        <i data-lucide="cpu" class="w-5 h-5"></i>
                                    </div>
                                    <span class="font-medium text-gray-700 dark:text-gray-200">What technical skills do
                                        you have?</span>
                                </div>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Messages -->
                <div id="messages" class="space-y-6 pb-2">
                    <!-- Messages injected here -->
                </div>

                <!-- Typing Indicator -->
                <div id="typing-indicator" class="hidden mb-6 pl-2 animate-fade-in-up">
                    <div class="flex items-end space-x-2">
                        <div
                            class="w-6 h-6 rounded-lg bg-gradient-to-br from-blue-500 to-indigo-600 flex items-center justify-center flex-shrink-0 shadow-md">
                            <i data-lucide="bot" class="w-3 h-3 text-white"></i>
                        </div>
                        <div
                            class="glass px-4 py-3 rounded-2xl rounded-tl-none shadow-sm border border-gray-100/50 dark:border-gray-700/50">
                            <div class="flex space-x-1 items-center h-4">
                                <div class="w-1.5 h-1.5 bg-blue-400 rounded-full animate-bounce"
                                    style="animation-delay: 0ms"></div>
                                <div class="w-1.5 h-1.5 bg-blue-500 rounded-full animate-bounce"
                                    style="animation-delay: 150ms"></div>
                                <div class="w-1.5 h-1.5 bg-blue-600 rounded-full animate-bounce"
                                    style="animation-delay: 300ms"></div>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- Spacer for scrolling -->
                <div class="h-8"></div>
            </div>
        </main>

        <!-- Scroll to bottom button -->
        <button id="scroll-to-bottom-btn" onclick="scrollToBottom()"
            class="absolute bottom-28 right-8 p-3 bg-white/80 dark:bg-gray-800/80 backdrop-blur text-gray-600 dark:text-gray-300 rounded-full shadow-lg border border-gray-200 dark:border-gray-700 hover:bg-white dark:hover:bg-gray-700 hover:-translate-y-1 transition-all duration-300 opacity-0 pointer-events-none translate-y-4 z-20 flex items-center justify-center group">
            <i data-lucide="arrow-down" class="w-5 h-5 group-hover:text-blue-500 transition-colors"></i>
        </button>

        <!-- Input Area -->
        <footer
            class="bg-white/80 dark:bg-gray-900/80 backdrop-blur-xl border-t border-gray-200/50 dark:border-gray-700/50 flex-none p-4 md:p-6 w-full z-10">
            <div class="max-w-4xl mx-auto w-full">
                <form id="chat-form"
                    class="relative flex items-end shadow-lg shadow-gray-200/50 dark:shadow-black/10 rounded-2xl bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 focus-within:ring-2 focus-within:ring-blue-500/50 focus-within:border-blue-500 transition-all duration-300 hover:border-gray-300 dark:hover:border-gray-600">
                    <textarea id="message-input" rows="1" placeholder="Type your message..."
                        class="w-full px-5 py-4 bg-transparent border-none focus:ring-0 resize-none text-gray-900 dark:text-white placeholder-gray-400 dark:placeholder-gray-500 max-h-[200px] overflow-hidden leading-relaxed text-[15px]"
                        style="min-height: 56px;"></textarea>

                    <div class="flex items-center pb-3 pr-3 ml-2">
                        <button type="submit" id="send-button" disabled
                            class="p-2.5 bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-700 hover:to-indigo-700 text-white rounded-xl transition-all duration-200 transform hover:scale-105 hover:shadow-md focus:outline-none disabled:opacity-50 disabled:cursor-not-allowed disabled:grayscale disabled:hover:scale-100 disabled:shadow-none">
                            <i data-lucide="send" class="w-4 h-4"></i>
                        </button>
                    </div>
                </form>
                <div class="mt-3 text-center">
                    <p class="text-[11px] text-gray-400 dark:text-gray-500 font-medium tracking-wide">
                        AI can make mistakes. Please verify important information.
                    </p>
                </div>
            </div>
        </footer>
    </div>
</div>

<!-- Chatbot Info Modal -->
<div id="chatbot-info-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6 w-full max-w-md relative">

        <!-- Close Button -->
        <button onclick="closeChatbotModal()"
            class="absolute top-3 right-3 text-gray-400 hover:text-gray-600 dark:hover:text-gray-200">
            <i data-lucide="x" class="w-5 h-5"></i>
        </button>

        <h2 class="text-xl font-semibold text-gray-900 dark:text-white mb-3">
            About {{ settings.chatbot_name }}
        </h2>

        <p class="text-gray-700 dark:text-gray-300 leading-relaxed text-sm">
            This AI assistant is designed to showcase Dan Walshâ€™s professional experience,
            projects, skills, and background through an interactive conversational interface.
            You can ask about technical skills, work experience, projects, analytics work,
            software engineering knowledge, or anything related. This application was built
            by Dan in python using flask and google's gemini AI.
        </p>

        <div class="mt-4 text-right">
            <button onclick="closeChatbotModal()"
                class="px-4 py-2 text-sm bg-blue-500 hover:bg-blue-600 text-white rounded-lg shadow">
                Close
            </button>
        </div>
    </div>
</div>


<script>
    // --- User Identity Management ---
    let userIdentifier = localStorage.getItem('chat_user_identifier');
    if (!userIdentifier) {
        // Generate a random UUID v4 if not exists
        userIdentifier = crypto.randomUUID();
        localStorage.setItem('chat_user_identifier', userIdentifier);
    }

    // --- State Management ---
    let sessionId = null; // Start with no session (New Chat state)
    let socket = null;
    let currentMode = 'conversational';
    let currentProfileId = null;
    let currentProfile = null;
    let currentStreamingMessageDiv = null;
    let currentStreamingContent = "";

    // --- UI Elements ---
    const messagesContainer = document.getElementById('messages');
    const chatContainer = document.getElementById('chat-container');
    const messageInput = document.getElementById('message-input');
    const chatForm = document.getElementById('chat-form');
    const typingIndicator = document.getElementById('typing-indicator');
    const statusText = document.getElementById('status-text');
    const statusIndicator = document.getElementById('status-indicator');
    const welcomeScreen = document.getElementById('welcome-screen');
    const historyList = document.getElementById('history-list');
    const profileSelector = document.getElementById('profile-selector');
    const sidebar = document.getElementById('sidebar');
    const sidebarOverlay = document.getElementById('sidebar-overlay');
    const scrollToBottomBtn = document.getElementById('scroll-to-bottom-btn');

    // --- Initialization ---
    document.addEventListener('DOMContentLoaded', async () => {
        setupAutoResize();
        setupScrollListener();
        await loadProfiles();
        loadHistory();

        // Check URL or LocalStorage for last session? 
        // For now, start fresh or load most recent?
        // Let's check if there is an active session in local storage we want to resume
        // But the "New Chat" logic suggests we might want to start fresh often.
        // Let's load the history list first, then decide.

        const lastSessionId = localStorage.getItem('last_active_session_id');
        if (lastSessionId) {
            await loadSession(lastSessionId);
        } else {
            startNewChat();
        }
    });

    document.addEventListener('click', function (event) {
        const modal = document.getElementById('chatbot-info-modal');
        if (!modal.classList.contains('hidden') && event.target === modal) {
            modal.classList.add('hidden');
        }
    });


    // --- Socket Connection ---
    function connectSocket() {
        if (socket) {
            socket.disconnect();
        }

        const queryFn = {
            user_identifier: userIdentifier
        };

        if (sessionId) {
            queryFn.session_id = sessionId;
        }

        socket = io({
            query: queryFn
        });

        socket.on('connect', () => {
            statusText.textContent = 'Online';
            statusIndicator.classList.remove('bg-gray-400');
            statusIndicator.classList.add('bg-green-500');
        });

        socket.on('disconnect', () => {
            statusText.textContent = 'Offline';
            statusIndicator.classList.remove('bg-green-500');
            statusIndicator.classList.add('bg-gray-400');
        });

        socket.on('connected', (data) => {
            // Server confirmed session ID
            if (sessionId !== data.session_id) {
                sessionId = data.session_id;
                // If it's a new session we just created, refresh history list after a moment to show it
                if (!lastSessionIdWasKnown) {
                    setTimeout(loadHistory, 2000);
                }
                localStorage.setItem('last_active_session_id', sessionId);
            }
            lastSessionIdWasKnown = true;
        });

        socket.on('message', (data) => {
            // Only add if it's NOT a streaming end confirmation
            // If role is assistant and we have a streaming div, we ignore it as we handle finalize in message_end
            if (data.role === 'assistant' && currentStreamingMessageDiv) {
                return;
            }

            welcomeScreen.style.display = 'none';
            addMessage(data.role, data.content, data.timestamp);
            loadHistory();
        });

        // Streaming Events
        socket.on('message_start', (data) => {
            welcomeScreen.style.display = 'none';
            currentStreamingContent = "";
            currentStreamingMessageDiv = addMessage('assistant', '', data.timestamp, true, true);
            toggleInputState(true);
        });

        socket.on('message_chunk', (data) => {
            if (!currentStreamingMessageDiv) return;
            currentStreamingContent += data.content;
            updateStreamingMessage(currentStreamingMessageDiv, currentStreamingContent);
        });

        socket.on('message_end', () => {
            if (currentStreamingMessageDiv) {
                finalizeStreamingMessage(currentStreamingMessageDiv, currentStreamingContent);
                currentStreamingMessageDiv = null;
                currentStreamingContent = "";
                toggleInputState(false);
                loadHistory();
                messageInput.focus();
            }
        });

        socket.on('typing', (data) => {
            // Only show typing indicator if NOT streaming
            if (data.typing && !currentStreamingMessageDiv) {
                typingIndicator.classList.remove('hidden');
                typingIndicator.scrollIntoView({ behavior: 'smooth', block: 'start' });
            } else {
                typingIndicator.classList.add('hidden');
            }
        });

        socket.on('error', (data) => {
            showToast(data.message, 'error');
            toggleInputState(false);
        });
    }


    function openChatbotModal() {
        const modal = document.getElementById('chatbot-info-modal');
        modal.classList.remove('hidden');
    }

    function closeChatbotModal() {
        const modal = document.getElementById('chatbot-info-modal');
        modal.classList.add('hidden');
    }


    let lastSessionIdWasKnown = false;

    // --- Chat Logic ---
    function startNewChat() {
        sessionId = null;
        lastSessionIdWasKnown = false;
        localStorage.removeItem('last_active_session_id');

        // Clear UI
        messagesContainer.innerHTML = '';
        welcomeScreen.style.display = 'flex';

        // Update active state in history list
        document.querySelectorAll('.history-item').forEach(el => el.classList.remove('bg-gray-200', 'dark:bg-gray-700'));

        // Connect socket (will generate new session ID on server)
        connectSocket();

        // Close sidebar on mobile if open
        if (window.innerWidth < 768 && !sidebar.classList.contains('-translate-x-full')) {
            toggleSidebar();
        }
        messageInput.focus();
    }

    async function loadSession(id) {
        if (sessionId === id) return;

        sessionId = id;
        localStorage.setItem('last_active_session_id', sessionId);

        // Clear UI
        messagesContainer.innerHTML = '';
        welcomeScreen.style.display = 'none'; // Optimistically hide

        // Fetch messages
        try {
            // Reuse admin endpoint? No, admin endpoint is protected.
            // We need a public endpoint or need to rely on 'history' endpoint to give us messages?
            // Wait, the plan didn't explicitly create a public 'get messages' endpoint only 'get history' (sessions).
            // Actually, we can use the `join_room` to get history? No, socket usually doesn't replay unless configured.
            // I need to add a public endpoint to get messages for a session belonging to user_identifier.
            // OR I can use the socket to request history. 
            // IMPROVEMENT: Let's fetch history via API. I missed adding `GET /api/history/<session_id>` in the plan's list but I added `DELETE`.
            // Let's add that endpoint quickly via a tool call if it's missing, OR I can rely on client-side storage? No, server is source of truth.

            // Checking api.py... I only added `GET /api/history` (list) and `DELETE`.
            // I need `GET /api/history/<session_id>/messages`

            // FALLBACK FOR NOW: Just connect. The history won't load from server!
            // WAIT - I need to fix this.
            // I will implement a quick fetch logic assuming I'll add the endpoint.

            const response = await fetch(`/api/history/${sessionId}/messages?user_identifier=${userIdentifier}`);
            if (response.ok) {
                const data = await response.json();
                if (data.messages && data.messages.length > 0) {
                    data.messages.forEach(msg => {
                        addMessage(msg.role, msg.content, msg.timestamp, false);
                    });
                    welcomeScreen.style.display = 'none';
                    setTimeout(() => scrollToBottom(false), 10);
                } else {
                    // No messages?
                    welcomeScreen.style.display = 'flex';
                }
            } else {
                console.error("Failed to load messages");
                // startNewChat(); // Fallback?
            }

        } catch (e) {
            console.error("Error loading session:", e);
        }

        // Connect socket for this session
        connectSocket();
        updateHistoryActiveState();

        if (window.innerWidth < 768 && !sidebar.classList.contains('-translate-x-full')) {
            toggleSidebar(); // Close sidebar
        }
        messageInput.focus();
    }

    async function loadHistory() {
        try {
            const response = await fetch(`/api/history?user_identifier=${userIdentifier}`);
            const sessions = await response.json();

            historyList.innerHTML = '';

            if (sessions.length === 0) {
                historyList.innerHTML = '<div class="text-center py-8 text-gray-400 text-sm">No recent chats</div>';
                return;
            }

            sessions.forEach(session => {
                const div = document.createElement('div');
                div.className = `history-item group flex items-center justify-between p-3 rounded-xl cursor-pointer transition-colors duration-200 hover:bg-gray-100 dark:hover:bg-gray-700 ${session.session_id === sessionId ? 'bg-gray-200 dark:bg-gray-700' : ''}`;
                div.dataset.sessionId = session.session_id;
                div.onclick = (e) => {
                    // Prevent clicking delete from triggering load
                    if (e.target.closest('.delete-btn')) return;
                    loadSession(session.session_id);
                };

                div.innerHTML = `
                    <div class="flex-1 min-w-0 pr-2">
                        <h3 class="text-sm font-medium text-gray-900 dark:text-gray-100 truncate">${escapeHtml(session.title)}</h3>
                        <p class="text-xs text-gray-500 dark:text-gray-400 truncate">${formatDate(session.last_activity)}</p>
                    </div>
                    <button class="delete-btn opacity-0 group-hover:opacity-100 p-1.5 text-gray-400 hover:text-red-500 rounded-md hover:bg-gray-200 dark:hover:bg-gray-600 transition-all"
                        onclick="deleteSession(event, '${session.session_id}')" title="Delete chat">
                        <i data-lucide="trash-2" class="w-4 h-4"></i>
                    </button>
                `;

                historyList.appendChild(div);
            });

            lucide.createIcons();

        } catch (error) {
            console.error('Error loading history:', error);
            historyList.innerHTML = '<div class="text-center py-4 text-red-400 text-sm">Failed to load history</div>';
        }
    }

    async function deleteSession(event, id) {
        event.stopPropagation();
        if (!confirm('Are you sure you want to delete this chat?')) return;

        try {
            const response = await fetch(`/api/history/${id}`, {
                method: 'DELETE'
            });

            if (!response.ok) throw new Error('Failed to delete');

            // Remove from UI
            const item = historyList.querySelector(`[data-session-id="${id}"]`);
            if (item) item.remove();

            // If current session, start new
            if (sessionId === id) {
                startNewChat();
            }

            showToast('Chat history deleted', 'success');
        } catch (e) {
            console.error('Delete failed', e);
            showToast('Failed to delete chat', 'error');
        }
    }

    function updateHistoryActiveState() {
        document.querySelectorAll('.history-item').forEach(el => {
            if (el.dataset.sessionId === sessionId) {
                el.classList.add('bg-gray-200', 'dark:bg-gray-700');
            } else {
                el.classList.remove('bg-gray-200', 'dark:bg-gray-700');
            }
        });
    }

    // --- Message Handling ---
    function sendQuickMessage(text) {
        messageInput.value = text;
        chatForm.dispatchEvent(new Event('submit'));
    }

    chatForm.addEventListener('submit', (e) => {
        e.preventDefault();
        const message = messageInput.value.trim();
        if (!message) return;

        // Optimistic add (optional, but good for UX)
        // addMessage('user', message, new Date().toISOString()); 
        // Better to wait for server echo to confirm logic but instant feedback is nice.
        // Let's stick to socket echo for simplicity so we don't duplicate.

        socket.emit('send_message', {
            session_id: sessionId,
            message: message,
            mode: currentMode,
            profile_id: currentProfileId
        });

        messageInput.value = '';
        messageInput.style.height = 'auto'; // Reset height
        messageInput.focus();
        welcomeScreen.style.display = 'none';
    });

    function addMessage(role, content, timestamp, smoothScroll = true, isStreaming = false) {
        const messageDiv = document.createElement('div');
        messageDiv.className = 'flex items-start space-x-3 mb-6 animate-fade-in group';

        // Format time
        const dateObj = timestamp ? new Date(timestamp) : new Date();
        const timeStr = dateObj.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

        if (role === 'user') {
            messageDiv.classList.add('flex-row-reverse', 'space-x-reverse');

            // User Message
            // Parse Markdown and Sanitize
            marked.setOptions({ breaks: true, gfm: true });
            let rawHtml = marked.parse(content);
            let formattedContent = DOMPurify.sanitize(rawHtml, {
                ADD_ATTR: ['target', 'class'],
                FORBID_TAGS: ['style', 'script']
            });

            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = formattedContent;
            tempDiv.querySelectorAll('a').forEach(link => {
                link.setAttribute('target', '_blank');
                link.classList.add('text-white', 'underline', 'hover:text-blue-100', 'break-all');
            });
            formattedContent = tempDiv.innerHTML;

            messageDiv.innerHTML = `
                <div class="user-avatar w-10 h-10 rounded-xl bg-gradient-to-br from-gray-700 to-gray-900 flex items-center justify-center flex-shrink-0 shadow-md">
                    <i data-lucide="user" class="w-5 h-5 text-white"></i>
                </div>
                <div class="flex flex-col items-end max-w-[85%] sm:max-w-xl">
                    <div class="bg-gradient-to-br from-blue-600 to-indigo-600 text-white rounded-2xl rounded-tr-sm shadow-md px-6 py-4 w-full">
                        <div class="text-[15px] leading-relaxed prose prose-invert max-w-none prose-p:leading-relaxed prose-p:my-1">${formattedContent}</div>
                    </div>
                    <span class="text-[11px] text-gray-400 mt-1.5 mr-1 font-medium opacity-0 group-hover:opacity-100 transition-opacity">${timeStr}</span>
                </div>
            `;
        } else {
            // Assistant Message
            let innerContent = '';

            if (isStreaming) {
                innerContent = `
                    <div class="flex items-center">
                        <span class="streaming-text text-gray-800 dark:text-gray-100"></span>
                        <span class="w-2 h-5 bg-blue-500 ml-1 animate-pulse rounded-full inline-block cursor-blink"></span>
                    </div>
                 `;
            } else {
                marked.setOptions({ breaks: true, gfm: true });
                let rawHtml = marked.parse(content);
                let formattedContent = DOMPurify.sanitize(rawHtml, {
                    ADD_ATTR: ['target', 'class'],
                    FORBID_TAGS: ['style', 'script']
                });

                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = formattedContent;
                tempDiv.querySelectorAll('a').forEach(link => {
                    link.setAttribute('target', '_blank');
                    link.classList.add('text-blue-600', 'dark:text-blue-400', 'underline', 'hover:text-blue-700', 'dark:hover:text-blue-500', 'break-all', 'font-medium');
                });
                innerContent = tempDiv.innerHTML;
            }

            messageDiv.innerHTML = `
                <div class="bot-avatar w-10 h-10 rounded-xl bg-gradient-to-br from-blue-500 to-indigo-600 flex items-center justify-center flex-shrink-0 shadow-md shadow-blue-500/20">
                    <i data-lucide="bot" class="w-6 h-6 text-white"></i>
                </div>
                <div class="flex flex-col items-start max-w-[85%] sm:max-w-2xl">
                    <div class="message-content glass bg-white dark:bg-gray-800 rounded-2xl rounded-tl-sm shadow-sm border border-gray-200/50 dark:border-gray-700/50 px-6 py-5 w-full">
                        <div class="text-[15px] leading-relaxed text-gray-800 dark:text-gray-100 prose dark:prose-invert max-w-none prose-headings:font-display prose-a:text-blue-600 dark:prose-a:text-blue-400 prose-code:bg-gray-100 dark:prose-code:bg-gray-800 prose-code:rounded prose-code:px-1 prose-code:py-0.5 prose-strong:text-gray-900 dark:prose-strong:text-white">
                            ${innerContent}
                        </div>
                    </div>
                     <span class="text-[11px] text-gray-400 mt-1.5 ml-1 font-medium opacity-0 group-hover:opacity-100 transition-opacity">${timeStr}</span>
                </div>
            `;
        }

        messagesContainer.appendChild(messageDiv);
        lucide.createIcons({ root: messageDiv });
        if (smoothScroll) {
            scrollToBottom();
        }

        return messageDiv;
    }

    function updateStreamingMessage(messageDiv, content) {
        const contentDiv = messageDiv.querySelector('.text-\\[15px\\]');
        if (!contentDiv) return;

        // Simple text update for now, or partial markdown if we want to be fancy.
        // For smoother streaming, we just show text. 
        // We can try to parse markdown on every chunk but valid HTML might break.
        // Let's stick to raw lines for streaming and replace with Markdown at end?
        // Or at least preserve newlines.

        // Better: Parse standard text but keep cursor.
        // We'll just update the text node for now to avoid re-rendering heavy HTML constantly.
        // But we want line breaks. replace \n with <br>.

        const formatted = escapeHtml(content).replace(/\n/g, '<br>');

        contentDiv.innerHTML = `
             <span>${formatted}</span>
             <span class="w-2 h-5 bg-blue-500 ml-0.5 animate-pulse rounded-full inline-block align-middle"></span>
        `;
        scrollToBottom();
    }

    function finalizeStreamingMessage(messageDiv, content) {
        const contentDiv = messageDiv.querySelector('.message-content');
        if (!contentDiv) return;

        marked.setOptions({ breaks: true, gfm: true });
        let rawHtml = marked.parse(content);
        let formattedContent = DOMPurify.sanitize(rawHtml, {
            ADD_ATTR: ['target', 'class'],
            FORBID_TAGS: ['style', 'script']
        });

        const tempDiv = document.createElement('div');
        tempDiv.innerHTML = formattedContent;
        tempDiv.querySelectorAll('a').forEach(link => {
            link.setAttribute('target', '_blank');
            link.classList.add('text-blue-600', 'dark:text-blue-400', 'underline', 'hover:text-blue-700', 'dark:hover:text-blue-500', 'break-all', 'font-medium');
        });

        // Replace content wrapper
        const innerDiv = contentDiv.querySelector('.text-\\[15px\\]');
        innerDiv.innerHTML = tempDiv.innerHTML;

        // Re-run icons?
        lucide.createIcons({ root: messageDiv });
        scrollToBottom();
    }

    // --- Helpers ---
    function scrollToBottom(smooth = true) {
        // If typing indicator is visible, scroll to it
        if (!typingIndicator.classList.contains('hidden')) {
            typingIndicator.scrollIntoView({ behavior: smooth ? 'smooth' : 'auto', block: 'start' });
        } else {
            // Scroll container to bottom
            chatContainer.scrollTo({
                top: chatContainer.scrollHeight,
                behavior: smooth ? 'smooth' : 'auto'
            });
        }
    }

    function setupScrollListener() {
        chatContainer.addEventListener('scroll', () => {
            const distanceToBottom = chatContainer.scrollHeight - chatContainer.scrollTop - chatContainer.clientHeight;
            if (distanceToBottom > 200) {
                scrollToBottomBtn.classList.remove('opacity-0', 'pointer-events-none', 'translate-y-2');
                scrollToBottomBtn.classList.add('opacity-100', 'translate-y-0');
            } else {
                scrollToBottomBtn.classList.add('opacity-0', 'pointer-events-none', 'translate-y-2');
                scrollToBottomBtn.classList.remove('opacity-100', 'translate-y-0');
            }
        });
    }

    function formatDate(isoString) {
        const date = new Date(isoString);
        const now = new Date();
        const diff = now - date;
        const days = Math.floor(diff / (1000 * 60 * 60 * 24));

        if (days === 0) {
            return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        } else if (days === 1) {
            return 'Yesterday';
        } else if (days < 7) {
            return date.toLocaleDateString([], { weekday: 'short' });
        } else {
            return date.toLocaleDateString([], { month: 'short', day: 'numeric' });
        }
    }

    function escapeHtml(text) {
        if (!text) return '';
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    function toggleSidebar() {
        sidebar.classList.toggle('-translate-x-full');
        // Overlay toggle
        if (sidebarOverlay.classList.contains('hidden')) {
            sidebarOverlay.classList.remove('hidden');
        } else {
            sidebarOverlay.classList.add('hidden');
        }
    }

    // --- Profile & Mode ---
    function setMode(mode) {
        currentMode = mode;
        const convBtn = document.getElementById('mode-conversational');
        const simpleBtn = document.getElementById('mode-simple');

        if (mode === 'conversational') {
            convBtn.classList.add('bg-white', 'dark:bg-gray-600', 'text-gray-900', 'dark:text-white', 'shadow-sm');
            convBtn.classList.remove('text-gray-500', 'dark:text-gray-400', 'hover:text-gray-900', 'dark:hover:text-white');
            simpleBtn.classList.remove('bg-white', 'dark:bg-gray-600', 'text-gray-900', 'dark:text-white', 'shadow-sm');
            simpleBtn.classList.add('text-gray-500', 'dark:text-gray-400', 'hover:text-gray-900', 'dark:hover:text-white');
        } else {
            simpleBtn.classList.add('bg-white', 'dark:bg-gray-600', 'text-gray-900', 'dark:text-white', 'shadow-sm');
            simpleBtn.classList.remove('text-gray-500', 'dark:text-gray-400', 'hover:text-gray-900', 'dark:hover:text-white');
            convBtn.classList.remove('bg-white', 'dark:bg-gray-600', 'text-gray-900', 'dark:text-white', 'shadow-sm');
            convBtn.classList.add('text-gray-500', 'dark:text-gray-400', 'hover:text-gray-900', 'dark:hover:text-white');
        }
    }

    async function loadProfiles() {
        try {
            const response = await fetch('/api/profiles');
            const profiles = await response.json();
            profileSelector.innerHTML = '';

            const savedProfileId = localStorage.getItem('selected_profile_id');

            profiles.forEach(profile => {
                const option = document.createElement('option');
                option.value = profile.id;
                option.textContent = profile.name + (profile.is_default ? ' (Default)' : '');

                if ((savedProfileId && profile.id == savedProfileId) || (!savedProfileId && profile.is_default)) {
                    option.selected = true;
                    currentProfileId = profile.id;
                    currentProfile = profile;
                    updateGreeting(profile);
                    document.getElementById('current-profile-name').textContent = profile.display_name || profile.name;
                }
                profileSelector.appendChild(option);
            });
            lucide.createIcons();
        } catch (error) {
            console.error('Error loading profiles:', error);
        }
    }

    profileSelector.addEventListener('change', async (e) => {
        currentProfileId = e.target.value ? parseInt(e.target.value) : null;
        localStorage.setItem('selected_profile_id', currentProfileId);

        try {
            // Refetch to get details
            const response = await fetch('/api/profiles');
            const profiles = await response.json();
            currentProfile = profiles.find(p => p.id == currentProfileId);
            if (currentProfile) {
                updateGreeting(currentProfile);
                document.getElementById('current-profile-name').textContent = currentProfile.display_name || currentProfile.name;
            }
        } catch (e) { }
    });

    function updateGreeting(profile) {
        if (!profile) return;
        const greetingName = document.getElementById('greeting-name');
        const greetingIntro = document.getElementById('greeting-intro');

        greetingName.textContent = `Hi! I'm ${profile.display_name || 'AI Assistant'}`;

        if (profile.introduction) {
            greetingIntro.innerHTML = profile.introduction;
        } else {
            greetingIntro.textContent = 'I\'d love to chat about my background and experience. What would you like to know?';
        }
    }

    // --- UI Helpers ---
    function toggleInputState(disabled) {
        messageInput.disabled = disabled;
        const sendButton = document.getElementById('send-button');
        sendButton.disabled = disabled; // Toggle button specifically

        if (disabled) {
            chatForm.classList.add('opacity-75', 'cursor-not-allowed');
        } else {
            chatForm.classList.remove('opacity-75', 'cursor-not-allowed');
            messageInput.focus();
            // Re-check input value to set button state correctly
            const message = messageInput.value.trim();
            sendButton.disabled = !message;
        }
    }

    function setupAutoResize() {
        const sendButton = document.getElementById('send-button');

        messageInput.addEventListener('input', function () {
            this.style.height = 'auto';
            this.style.height = Math.min(this.scrollHeight, 200) + 'px';

            // Toggle send button
            const message = this.value.trim();
            if (message) {
                sendButton.disabled = false;
                sendButton.classList.remove('opacity-50', 'cursor-not-allowed', 'grayscale');
            } else {
                sendButton.disabled = true;
                sendButton.classList.add('opacity-50', 'cursor-not-allowed', 'grayscale');
            }
        });

        messageInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                if (!messageInput.value.trim()) return; // Don't submit empty
                chatForm.dispatchEvent(new Event('submit'));
            }
        });
    }

</script>
{% endblock %}